<div class="dialog-container">
  <h1 mat-dialog-title>
    Extend CDM @if (form.get('id')?.value) {
    <span> - {{ form.get("id")?.value }}</span>
    }
  </h1>

  <div mat-dialog-content [formGroup]="form" class="dialog-grid">
    <!-- Render fixed CDM fields first -->
    @for (key of ['label', 'description', 'olsId', 'ohdsiId']; track key) { @if
    ( form.get(key)) {
    <div class="field-wrapper" [class]="key">
      <mat-form-field appearance="fill" class="full-width">
        <mat-label>{{ fieldLabels[key] || (key | titlecase) }}</mat-label>

        <!-- Input rendering -->
        @if (key === 'ohdsiId') {
        <!-- OHDSI ID input -->
        <input
          matInput
          [formControlName]="key"
          (blur)="fetchOhdsiData()"
          placeholder="Enter OHDSI ID (e.g., 123456)"
        />
        @if (ohdsiLoading) {
        <mat-progress-spinner
          diameter="20"
          mode="indeterminate"
          class="spinner"
        ></mat-progress-spinner>
        } @if (ohdsiError) {
        <mat-error>{{ ohdsiError }}</mat-error>
        } } @else if (key === 'olsId') {
        <!-- OLS ID input -->
        <input
          matInput
          [formControlName]="key"
          (blur)="fetchOlsData()"
          placeholder="Enter OLS ID (e.g., EFO:0000311)"
        />
        @if (olsLoading) {
        <mat-progress-spinner
          diameter="20"
          mode="indeterminate"
          class="spinner"
        ></mat-progress-spinner>
        } @if (olsError) {
        <mat-error>{{ olsError }}</mat-error>
        } } @else {
        <!-- Default input -->
        <input matInput [formControlName]="key" />
        @if (hasRequiredError(key)) {
        <mat-error> {{ fieldLabels[key] || key }} is required. </mat-error>
        } @if (form.get(key)?.hasError('labelExists')) {
        <mat-error>A variable with this label already exists.</mat-error>
        } }
      </mat-form-field>

      <!-- OHDSI Accordion right after OHDSI ID -->
      @if (key === 'ohdsiId' && form.get('ohdsiLabel')?.value) {
      <mat-accordion>
        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title>Auto-filled OHDSI Information</mat-panel-title>
          </mat-expansion-panel-header>
          <div class="accordion-fields">
            <mat-form-field appearance="fill" class="full-width">
              <mat-label>OHDSI Label</mat-label>
              <input
                matInput
                [formControl]="getControl('ohdsiLabel')"
                readonly
              />
            </mat-form-field>
            <mat-form-field appearance="fill" class="full-width">
              <mat-label>OHDSI Domain</mat-label>
              <input
                matInput
                [formControl]="getControl('ohdsiDomain')"
                readonly
              />
            </mat-form-field>
          </div>
        </mat-expansion-panel>
      </mat-accordion>
      }

      <!-- OLS Accordion right after OLS ID -->
      @if (key === 'olsId' && form.get('olsLabel')?.value) {
      <mat-accordion>
        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title>Auto-filled OLS Information</mat-panel-title>
          </mat-expansion-panel-header>
          <div class="accordion-fields">
            <mat-form-field appearance="fill" class="full-width">
              <mat-label>OLS Label</mat-label>
              <input matInput [formControl]="getControl('olsLabel')" readonly />
            </mat-form-field>
            <mat-form-field appearance="fill" class="full-width">
              <mat-label>OLS Description</mat-label>
              <textarea
                matInput
                [formControl]="getControl('olsDescription')"
                readonly
              ></textarea>
            </mat-form-field>
          </div>
        </mat-expansion-panel>
      </mat-accordion>
      }
    </div>
    } }
    <!-- Render each study's Label + Description side-by-side -->
    @for (studyName of data.studyColumnNames; track studyName) {
    <div class="field-wrapper" [class]="studyName">
      <mat-form-field appearance="fill" class="full-width">
        <mat-label>{{ studyName | uppercase }} Label</mat-label>
        <input
          matInput
          [formControlName]="tableService.toCamelCase(studyName) + 'Label'"
        />
      </mat-form-field>
    </div>
    <div class="field-wrapper" [class]="studyName">
      <mat-form-field appearance="fill" class="full-width">
        <mat-label>{{ studyName | uppercase }} Description</mat-label>
        <input
          matInput
          [formControlName]="
            tableService.toCamelCase(studyName) + 'Description'
          "
        />
      </mat-form-field>
    </div>
    }
  </div>

  <div mat-dialog-actions align="end">
    <button mat-button (click)="cancel()">Cancel</button>
    <button
      mat-button
      color="primary"
      [disabled]="form.invalid || ohdsiError || olsError"
      (click)="submit()"
    >
      Add
    </button>
  </div>
</div>
